<!DOCTYPE html>
<script>
/*
  Adwall client relay script

  This script runs on a static page (e.g. GitHub Pages) and acts as a relay
  between the user's browser and a local Node.js application.

  Flow:
  1. The user opens this page in a browser.
  2. If no hash is present, the page redirects to the local app (/init).
  3. The local app responds with a redirect back to this page, including
     a base64url-encoded payload in the URL hash.
  4. The payload contains a session identifier generated by the app.
  5. The script computes a validation code using the shared secret.
  6. The browser is redirected back to the local app with the validation code.

  Notes:
  - No server logic is required on this page.
  - The shared key must match the one used by the Node.js app.
  - The URL hash is used so data is not sent to any remote server.
  - Obfuscation is optional and only raises the cost of reverse engineering.
*/

const SHARED_KEY = "place_your_key_here"

/*
  Computes SHA-256 hash using the Web Crypto API.
  Returns a hexadecimal string.
*/
async function sha256(v) {
  const buf = await crypto.subtle.digest(
    "SHA-256",
    new TextEncoder().encode(v)
  )
  return [...new Uint8Array(buf)]
    .map(b => b.toString(16).padStart(2, "0"))
    .join("")
}

/*
  First visit:
  - No hash present in the URL.
  - Redirects the browser to the local app initialization endpoint.
*/
if (!location.hash) {
  location.href = "http://localhost:4173/init"
} else {
  /*
    Return visit from the local app:
    - The hash contains a base64url-encoded JSON payload.
    - The payload includes the session identifier.
  */
  const payload = JSON.parse(
    atob(location.hash.slice(1))
  )

  /*
    Generate the validation code using the session id and shared key,
    then redirect back to the local app for final verification.
  */
  sha256(payload.s + SHARED_KEY).then(code => {
    location.href =
      "http://localhost:4173/?v=" + code
  })
}
</script>
