<!DOCTYPE html>
<script>
/**
 * Adwall client relay script
 * 
 * This script runs on a static page (e.g. GitHub Pages) and acts as a relay
 * between the user's browser and a local Node.js application.
 * 
 * Anti-bypass security measures:
 * - Validates referrer to ensure request comes from adwall page
 * - Enforces session expiration (5 min default)
 * - Enforces minimum delay before redirect (15 sec default)
 * - Uses cryptographic validation codes
 * 
 * Flow:
 * 1. User opens this page in a browser
 * 2. If no hash present, page calls /init to get sessionId, adlink, etc
 * 3. /init validates request and returns session parameters
 * 4. Script displays adwall content and enforces minDelay
 * 5. Script generates validation code using sessionId + sharedKey
 * 6. Browser redirects to callbackUrl with validation code and referrer
 * 7. Server validates: referrer, session expiration, and delay
 * 8. On success, user is redirected to adlink (the target URL)
 * 
 * Notes:
 * - No server logic required on this page
 * - Shared key must match the Node.js app
 * - Referrer is sent by browser automatically (not in URL hash)
 * - Tampering with URL hash is detected and rejected
 */

const SHARED_KEY = "place_your_key_here"
let sessionData = null

/**
 * Computes SHA-256 hash using Web Crypto API
 * Returns hexadecimal string
 */
async function sha256(v) {
  const buf = await crypto.subtle.digest(
    "SHA-256",
    new TextEncoder().encode(v)
  )
  return [...new Uint8Array(buf)]
    .map(b => b.toString(16).padStart(2, "0"))
    .join("")
}

/**
 * Initialize session by calling /init endpoint
 * Retrieves sessionId, adlink, minDelay, and other parameters
 */
async function initSession() {
  try {
    const response = await fetch('http://localhost:4173/init')
    if (!response.ok) throw new Error('Init request failed')
    
    sessionData = await response.json()
    
    // Display adwall page content
    showAdwall()
    
    // Enforce minimum delay before allowing redirect
    const startTime = Date.now()
    const redirectButton = document.getElementById('complete-adwall')
    redirectButton.disabled = true
    
    // Update button countdown
    const updateCountdown = () => {
      const elapsed = Date.now() - startTime
      const remaining = Math.max(0, sessionData.minDelay - elapsed)
      redirectButton.textContent = remaining > 0 
        ? `Complete Adwall (${Math.ceil(remaining / 1000)}s)`
        : "Complete Adwall"
      redirectButton.disabled = remaining > 0
      
      if (remaining > 0) {
        requestAnimationFrame(updateCountdown)
      }
    }
    
    updateCountdown()
    redirectButton.onclick = completeAdwall
    
  } catch (error) {
    console.error('Session init failed:', error)
    showError('Failed to initialize adwall session. Please refresh.')
  }
}

/**
 * Complete adwall validation
 * Generates validation code and redirects to callback URL
 */
async function completeAdwall() {
  if (!sessionData) return
  
  // Generate validation code
  const validationCode = await sha256(sessionData.sessionId + SHARED_KEY)
  
  // Redirect to callback with validation code
  // Browser automatically includes referrer header for anti-bypass validation
  window.location.href = `${sessionData.callbackUrl}?v=${validationCode}`
}

/**
 * Display error message
 */
function showError(message) {
  document.body.innerHTML = `
    <div style="padding: 20px; text-align: center; font-family: Arial;">
      <h2>‚ùå Error</h2>
      <p>${message}</p>
      <button onclick="location.reload()">Retry</button>
    </div>
  `
}

/**
 * Display adwall page content
 */
function showAdwall() {
  document.body.innerHTML = `
    <div style="padding: 40px; text-align: center; font-family: Arial; max-width: 600px; margin: 50px auto;">
      <h1>üéÅ Special Offer</h1>
      <p>Please watch this adwall to continue</p>
      
      <div style="background: #f0f0f0; padding: 40px; margin: 30px 0; border-radius: 8px;">
        <p>Advertisement content goes here</p>
        <p style="font-size: 24px;">üí∞ Get your reward!</p>
      </div>
      
      <button id="complete-adwall" 
              style="padding: 15px 30px; font-size: 16px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 5px;">
        Loading...
      </button>
      
      <p style="margin-top: 20px; font-size: 12px; color: #666;">
        üîí Secure validation | Anti-bypass enabled
      </p>
    </div>
  `
}

/**
 * Main entry point
 * Check if this is the initial load or a return from the app
 */
if (!location.hash) {
  // Initial load - initialize session
  initSession()
} else {
  // This shouldn't happen in normal flow
  // (callback redirects to app, not back to this page)
  showError('Invalid redirect. Please start over.')
}
</script>

